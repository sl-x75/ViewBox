name: Build and Release

# When to run this workflow
on:
  # Trigger when you push a version tag
  push:
    tags:
      - 'v*.*.*'  # e.g., v1.0.0, v1.2.3, v2.0.0-beta
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# Environment variables for all jobs
env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # Job 1: Build for macOS
  # ============================================
  build-macos:
    runs-on: macos-latest  # GitHub's macOS machine
    
    steps:
      # 1. Download your code from GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Install Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci  # ci = clean install (faster than npm install)
      
      # 4. Build for macOS
      - name: Build macOS app
        run: npm run build:mac
        env:
          # Disable auto-update and notarization (we're not signing)
          SKIP_NOTARIZATION: true
      
      # 5. Upload the built app to GitHub
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            release/*.dmg
            release/*.zip
          retention-days: 7  # Keep for 7 days

  # ============================================
  # Job 2: Build for Windows
  # ============================================
  build-windows:
    runs-on: windows-latest  # GitHub's Windows machine
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Windows app
        run: npm run build:win
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            release/*.exe
            release/*.zip
          retention-days: 7

  # ============================================
  # Job 3: Build for Linux
  # ============================================
  build-linux:
    runs-on: ubuntu-latest  # GitHub's Linux machine
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Linux app
        run: npm run build:linux
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            release/*.AppImage
            release/*.deb
          retention-days: 7

  # ============================================
  # Job 4: Create GitHub Release
  # ============================================
create-release:
  needs: [build-macos, build-windows, build-linux]
  runs-on: ubuntu-latest
  
  permissions:
    contents: write
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Download all the built apps
    - name: Download macOS build
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: ./release-assets/macos
    
    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: ./release-assets/windows
    
    - name: Download Linux build
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: ./release-assets/linux
    
    # Get version
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    # === NEW: Prepare additional assets ===
    - name: Copy assets
      run: |
        # Copy pre-existing files from repo
        cp -r release-assets/assets ./final-assets/
        
    
    # Create GitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ./release-assets/*

        body: |
          ## ðŸŽ‰ Release ${{ steps.get_version.outputs.VERSION }}
          
          ### ðŸ“¦ Downloads
          
          **Application Installers:**
          - macOS: Download `.dmg` (Universal - Intel & Apple Silicon)
          - Windows: Download `.exe` installer
          - Linux: Download `.AppImage` or `.deb`
          
          **Additional Files:**
          - ðŸ“¦ **VieBox-extras.zip** -  assets
          
          ### ðŸ“š What's Included in Extras
          - Patterns.svg 
          - Symbols.svg  
          - Default.css

          
          [Installation instructions â†’](https://github.com/sl-x75/ViewBox#README_INSTALLATION.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


